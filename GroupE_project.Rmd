---
title: "Report"
author: "A. Gottardi, E. Corrolezzis, A. XYZ, L.F. Palacios Flores"
output: 
  html_document:
  toc: true
editor_options: 
  markdown: 
  wrap: 72
---


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(patchwork); library(GGally); library(ggplot2); library(car); library(mgcv); library(skimr); library(viridis)
library(psych); library(gridExtra); library(dplyr)
```

```{r, include=FALSE}
current_path <- getwd()
datasets_dir <- file.path(current_path, "datasets")
load(paste(datasets_dir, "train_df.RData", sep = "/"))
load(paste(datasets_dir, "train_reduced.RData", sep = "/"))

df <- read.csv(paste(datasets_dir, 'train.csv', sep = "/"))
```

# "Doubt the data until the data leave no room for doubt." - Henri PoincarÃ©

## Problem statement
The dataset contains the data of the clients of an Insurance company that has provided Health Insurance. 
Our goal is to analyze the relationship between the features and the probability of the customers buying a vehichle insurance.
Now, in order to predict whether the customer would be interested in Vehicle insurance, we have information about demographics (gender, age, region code type), Vehicles (Vehicle Age, Damage), Policy (Premium, sourcing channel) etc.

Our client is an Insurance company that has provided Health Insurance to its customers. Now they need the help in building a model to predict whether the policyholders (customers) from the past year will also be interested in Vehicle Insurance provided by the company.

An insurance policy is an arrangement by which a company undertakes to provide a guarantee of compensation for specified loss, damage, illness, or death in return for the payment of a specified premium. A premium is a sum of money that the customer needs to pay regularly to an insurance company for this guarantee.

Building a model to predict whether a customer would be interested in Vehicle Insurance is extremely helpful for the company because it can then accordingly plan its communication strategy to reach out to those customers and optimize its business model and revenue.

## Exploratory data analysis
The first step is trying to get some insights about the dataset by plotting and analysing the data. We present the barplots for the categorical variables and the histograms for the numerical ones.
```{r, fig.width=15, fig.height=15}
p2 <- ggpairs(train_df, 
              columns = c("Age", "Annual_Premium", "Vintage"),
              aes(color = Response),
              diag = list(discrete="barDiag", 
                          continuous = wrap("densityDiag", alpha=0.7)))
p2
```
The distribution of the Age variable with respect to the Response variable shows that the majority of the customers who are interested in car insurance are middle-aged (between 30 and 60 years old), which coindicdes with the age people are more likely to own a car. 
The customers not interested in acquiring a car insurance policy are mostly distributed among yourger people and some middle-aged adults in their 50s. The distribution is slightly skewed to the right.

The histogram for Annual Premium suggest that the costs of the car insurance policy is independent of the interest if the customers to buy the product. It has a highly right-skewed distribution, with most of the data concentrated on the lower end of the premium scale and a long tail extending to higher premium values. The lower tail shows a high values as a consequence of entry level health insurance policy as expected. 

The histogram for Vintage shows a nearly uniform distribution, with a slight increase in frequency towards the middle range of the Vintage variable.

The variables show negligible linear correlation between them, which is clearly shown in the scatter plot and in the correlation coeffcients.


```{r, fig.width=15, fig.height=9}
p9 <- ggplot(train_df, aes(x = Region_Code, fill = Response)) + 
  geom_bar(position = "dodge", color = "black") +
  labs(y = "Count", fill = "Response") +
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = 10)]) +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size = 14)
  )


p14 <- ggplot(train_df, aes(x = Policy_Sales_Channel, fill = Response)) + 
  geom_bar(position = "dodge", color = "black") +
  labs(y = "Count", fill = "Response") +
  scale_x_discrete(breaks = function(x) x[seq(1, length(x), by = 20)]) +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size = 14)
  )
p_cat <- p9 + p14
p_cat
```


Compute skim. We observe that there are not missing values and that the Response variable has an inbalance rate of 7.15 (put code) so we don't need to act to fix that.
Also the id value doesn't seem significant, since it is uniform and it is just a customer identifier. So we decided to exclude it from the training. 

The vast majority of the customers are from region 28. The customers from region 28 are also the ones who are most interested in car insurance. 
Almost half of the customers are distributed among regions 8, 28, 41, 46 accounting for ~47% of the total customers.
The customers of all the other regions account for almost the same amount of interested customers as the customers from region 28.

The vast majority of the customers where contacted from channel 152. However, the rest of the channels are more likely to be interested in the car insurance product. Channels 26, 124, 152 and 160 alone account for more than 80% of the customers. Channels 26 and 124 are the ones with the highest percentage of customers interested in the product. Abut 20% of the customers interested in the product are distributed in the rest of the channels of outreach. Channel 160 is the one with the lowest percentage of customers interested in the product.

*Since the two categorical variables have a high number of levels and the majority of the categories have small fequency, we decided to group them toghether: we maintained the 4 most frequent categories and grouped the other in a 5 category.*
  
  
  After the grouping:
```{r}
p10 <- ggplot(train_reduced, aes(x = Region_Reduced, fill = Response)) + 
  geom_bar(position = "dodge", color = "black") +
  labs(y = "Count", fill = "Response") +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size = 14)
  ) + 
  guides(fill = FALSE)
p15 <- ggplot(train_reduced, aes(x = Channels_Reduced, fill = Response)) + 
  geom_bar(position = "dodge", color = "black") +
  labs(y = "Count", fill = "Response") +
  theme(
    text = element_text(size = 12),
    axis.text = element_text(size = 14)
  ) + 
  guides(fill = FALSE)
p10+p15
```

*Train/test divison* We have divided the original dataset into a train and test dataset according to a 70% split. Also we deleted the non reduced version of the variables.


Approach:
  - create a ranking of the variables

## glm

### training
### testing
### comparison


## gam
### training
### testing
### comparison


## RF??

## Final conclusions
